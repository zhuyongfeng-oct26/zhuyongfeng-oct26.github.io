---
layout: post
title: 如何避免缓存雪崩、击穿、穿透？
categories: Redis
description:
keywords: 数据库
---

# 如何避免缓存雪崩、击穿、穿透

![](/images/posts/redis/08.png)

使用缓存可以避免反复向数据库请求相同数据，降低数据库负载，提高系统性能和响应速度，特别适用于频繁读取但变化不频繁的数据，从而显著减轻数据库压力。然而引入了缓存，就会有缓存异常的三个问题，分别是 **缓存雪崩、缓存击穿、缓存穿透。**

# 缓存雪崩

为了能够保证缓存和数据库中的数据保持一致性，在设置缓存时，会给 key 设置一个过期时间，当缓存过期时，业务系统需要访问数据库获取数据，并重新把数据写入缓存，这样后续的请求就可以命中缓存，直接返回响应了。

![](/images/posts/redis/09.png)

那么，**当大量缓存在同一时间失效（过期）或Redis宕机**时，如果此时有大量的业务请求进来，并且无法在缓存层中进行处理，就会全部请求数据库，导致数据库压力激增，严重的话会造成数据库宕机，引发连锁反应，从而导致系统奔溃。

可以看到，引发缓存雪崩主要有两个原因

- 大量缓存数据同时过期
- Redis故障

## 大量缓存数据同时过期

针对大量缓存数据同时过期导致的缓存雪崩，常见的应对方法有以下三种：

- 均匀设置过期时间
- 互斥锁
- 后台线程更新

### 均匀设置过期时间

给缓存的过期时间加上一个随机数，可以避免在同一时间批量写入的缓存，在同一时间过期。

### 互斥锁

当业务请求在访问数据时，如果发现数据不在缓存中，可以先加上一个互斥锁，保证在同一时间内只有一个请求来构建数据（从数据库获取数据，并写入缓存中），直到缓存构建完成后再释放锁。而其他请求，要么等待锁释放后再重新获取缓存，要么直接返回空值或默认值。

实现互斥锁时，最好加上超时时间，避免拿到锁的请求因意外发生阻塞一直不释放锁，导致其他请求一直等待，导致整个系统出现请求无响应的现象。

## Redis故障

针对Redis故障的情况，常见的应对方法有以下二种：

- 搭建高可用集群
- 服务熔断或请求限流

### 搭建高可用集群

如果Redis的主节点发生宕机，从节点可以切换为主节点，继续提供缓存服务。避免Redis因宕机而引发雪崩的问题。

### 服务熔断或请求限流

1. 当发生Redis 故障宕机而导致缓存雪崩问题时，可以启动服务熔断，暂停业务应用对缓存服务的请求，直接返回错误。然后等待Redis服务恢复后，再重新开放。
2. 为了减少对业务的影响，我们可以启用**请求限流**机制，**只将少部分请求发送到数据库进行处理，再多的请求就在入口直接拒绝服务**，等到 Redis 恢复正常并把缓存预热完后，再解除请求限流的机制。

# 缓存击穿

如果缓存中的**某个热点数据过期**了，此时大量的请求访问了该热点数据，就无法从缓存中读取，直接访问数据库，数据库很容易就被高并发的请求冲垮，这就是**缓存击穿**的问题。

![](/images/posts/redis/10.png)

可以发现缓存击穿和缓存雪崩很相似，可以理解简单理解为缓存击穿是缓存雪崩的子集。应对缓存击穿可以采取一下两种方案：

- 互斥锁方案，保证同一时间只有一个业务线程更新缓存，未能获取互斥锁的请求，要么等待锁释放后重新读取缓存，要么就返回空值或者默认值。
- 不给热点数据设置过期时间，由后台线程异步更新缓存；或者在热点数据准备要过期前，提前通知后台线程更新缓存以及重新设置过期时间。

# 缓存穿透

缓存穿透是指当用户请求的数据既不在缓存，也不在数据库中，导致请求先访问缓存，发现缓存缺失，然后再访问数据库时同样未找到数据。在大量这样的请求涌入时，数据库面临巨大压力，因为无法通过缓存构建数据来为后续请求提供服务。

缓存穿透的发生一般有这两种情况：

- 黑客恶意攻击，故意访问并不存在的数据。
- 数据误删，缓存中的数据和数据库中的数据都被误删除了，所以导致缓存和数据库中都没有数据。

应对缓存穿透的方案，常见的方案有三种。

### 限制非法请求

通过在API入口处对请求用户身份和请求参数进行校验，如果判断出是恶意请求就直接返回错误，避免进一步访问缓存和数据库。

### 缓存空值或缺省值

当缓存和数据库中都没有数据时，给缓存设置一个空值或缺省值，避免大量请求重复查询数据库。

### 布隆过滤器

布隆过滤器是一种快速判断元素是否存在于集合中的数据结构，通过减少不必要的数据库查询，有助于减轻数据库负载。

我们可以在写入数据库数据时，使用布隆过滤器做个标记，然后在用户请求到来时，业务线程确认缓存失效后，可以通过查询布隆过滤器快速判断数据是否存在，如果不存在，就不用通过查询数据库来判断数据是否存在。

---

简单介绍布隆过滤器的工作原理：

布隆过滤器由「初始值都为0的位图数组」和「N个哈希函数」组成。在写入数据库数据时，可以在布隆过滤器中进行标记。下次查询数据是否在数据库时，只需查询布隆过滤器。如果查询到数据没有被标记，说明数据不在数据库中。这样通过布隆过滤器的快速判断，可以减少不必要的数据库查询，提高系统性能。

布隆过滤器会通过 3 个操作完成标记：

- 第一步，使用 N 个哈希函数分别对数据做哈希计算，得到 N 个哈希值。
- 第二步，将第一步得到的 N 个哈希值对位图数组的长度取模，得到每个哈希值在位图数组的对应位置。
- 第三步，将每个哈希值在位图数组的对应位置的值设置为 1；

![](/images/posts/redis/11.png)

**当业务应用要查询数据是否存在于数据库时，通过布隆过滤器只要查到位图数组的第 1、4、6 位置的值是否全为 1，只要有一个为 0，就认为数据 x 不在数据库中**。