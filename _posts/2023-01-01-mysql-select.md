---
layout: post
title: 一条select语句的执行过程
categories: MySQL
description:
keywords: MySQL
---

# 一条select语句的执行过程

![](/images/posts/mysql/01.png)

MySQL的架构共分为两层：「Server层」和「存储引擎层」。

Server层在架构中负责处理大部分的核心功能服务，包括与客户端建立和管理连接、查询缓存、解析SQL、预处理器、优化器、执行器。同时还提供了大量的内置函数，如日期、时间、数学函数和加密函数等，这些函数可以在SQL查询中直接使用。

存储引擎层是整个架构中的底层组件，主要负责管理数据的存储和检索。这一层实现了数据的物理存储和索引结构，并执行各种数据库操作，如增删改查、管理锁、并发控制等。

![](/images/posts/mysql/02.png)

## 连接器

连接器负责与客户端建立连接、获取权限、维持和管理连接。

### 建立连接

首先，想要与MySQL建立连接，我们可以执行如下命令：

```bash
# -h 指定IP地址
# -u 指定用户名
# -p 指定密码
mysql -h$ip -u$user -p
```

MySQL是基于TCP协议进行数据传输的，在连接的过程中需要经过TCP三次握手，我们可以通过抓包工具观察这一过程。

## 查询缓存

MySQL执行过的查询语句，可能会以「key-value」的形式被缓存起来。因此当你进行一个查询请求后，会先到「查询缓存」查找是否存在缓存信息，如果能找到，那么就会直接返回该记录，这样就不需要执行后面的复杂操作。

但是大多数情况下，都不建议使用查询缓存。

查询缓存的失效非常频繁，只有对一张表进行一次更新操作，这张表上的所有查询缓存都会被清空。对于更新压力大的数据库表来说，查询缓存的命中率非常低。

MySQL提供了禁用查询缓存的配置：

```bash
query_cache_type=DEMAND
```

而对于你确定要使用查询缓存的语句，可以使用  SQL_CACHE 显式指定：

```sql
select SQL_CACHE * from user where id = 1;
```

需要注意的是，MySQL8.0版本直接把查询缓存的整块功能删除掉了。

## 解析SQL

在真正执行SQL查询语句之前，需要先对SQL语句进行解析，这个工具交由「解析器」完成。

### 解析器

解析器的工作分为两个步骤，分别是词法分析、语法分析。

我们以这条SQL查询语句为例进行解析：

```sql
select username from user;
```

- 词法分析

  MySQL通过解析这条SQL语句，会得到4个token，其中两个是关键字，分别是select、from

  | 关键字 | 非关键字 | 关键字 | 非关键字 |
      | --- | --- | --- | --- |
  | select | username | from | user |
- 语法分析

  通过语法规则进行解析，构建出SQL语法树，可以判断出这条SQL是否符合MySQL语法。

![](/images/posts/mysql/03.png)


举个例子，以下这个常见异常就是在语法分析这一阶段抛出来的。

![](/images/posts/mysql/04.png)

## 执行SQL

进入到执行SQL查询语句的流程，主要分为以下三个阶段。

- 预处理阶段
- 优化阶段
- 执行阶段

### 预处理器

```sql
select * from user;
```

预处理阶段主要做两个事情，分别是：

- 检查SQL查询语句中的表或者字段是否存在；
- 将 select * 中的 * 符号，扩展为表上的所有列；

### 优化器

优化器是当表里有多个索引时，决定使用哪个索引；或者在一个语句有多表关联时，决定各个表的连接顺序。

例如以下SQL查询语句：

```sql
select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;
```

- 既可以先从表 t1 里面取出 c=10 的记录的 ID 值，再根据 ID 值关联到表 t2，再判断 t2 里面 d 的值是否等于 20。
- 也可以先从表 t2 里面取出 d=20 的记录的 ID 值，再根据 ID 值关联到 t1，再判断 t1 里面 c 的值是否等于 10。

这两种方案的执行结果都是一样的，优化器会根据一定的规则，选择它认为执行效率最好的方案。

### 执行器

执行器会根据执行计划，执行 SQL 查询语句，从存储引擎读取记录，返回给客户端。

```sql
select * from T where username = 'xiaoming';
```

例如以上的SQL查询语句所在表并没有建立任何索引，那么它的执行顺序会是这样的：

- 调用 InnoDB 引擎接口取这个表的第一行，判断 username 值是否等于 xiaoming，如果不是则跳过，如果是则将这行存在结果集中；
- 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。
- 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。